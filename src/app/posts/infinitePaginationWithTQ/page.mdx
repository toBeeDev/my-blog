import ArticleLayout from "@/components/ArticleLayout";

export const article = {
  author: "Chan",
  date: "2024-03-21",
  title: "ğŸ“œ Infinite Pagination with Tanstack Query",
  description:
    "Infinite Scrollì„ Tanstack Queryë¥¼ í™œìš©í•  ìˆ˜ ìˆë‹¤ë©´ ì–¼ë§ˆë‚˜ ì¢‹ì„ê¹Œ?ì—ì„œ ì‹œì‘ëœ ê°„ë‹¨í•œ ê¸°ëŠ¥ êµ¬í˜„ ê¸€",
};

export const metadata = {
  title: article.title,
  description: article.description,
};

export default (props) => <ArticleLayout article={article} {...props} />;

<aside>
ğŸ’¡ ì–¸ì œê°€ëŠ” ì‚¬ìš©í•˜ê²Œ ë , Infinite Scrollì„ React Queryë¥¼ í™œìš©í•  ìˆ˜ ìˆë‹¤ë©´ ì–¼ë§ˆë‚˜ ì¢‹ì„ê¹Œ?ì—ì„œ ì‹œì‘ëœ ê°„ë‹¨í•œ ê¸°ëŠ¥ êµ¬í˜„

</aside>

## Setup

```tsx
npx create-react-app infinite --template typescript
//
npm i @tanstack/react-query
//
npm i react-intersection-observer
```

```tsx
//App.tsx
import React from "react";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import ReactDOM from "react-dom/client";
import App from "./App";

const root = ReactDOM.createRoot(
  document.getElementById("root") as HTMLElement
);

//queryClient ì „ì—­ì„¤ì •
const queryClient = new QueryClient();

root.render(
  <React.StrictMode>
    <QueryClientProvider client={queryClient}>
      <App />
    </QueryClientProvider>
  </React.StrictMode>
);
```

Infinite Scroll êµ¬í˜„ì„ ìœ„í•œ ì„ì˜ì´ item ìƒì„±ì„ ìœ„í•œ í•¨ìˆ˜

[Array.from() - JavaScript | MDN](https://developer.mozilla.org/ko/docs/Web/JavaScript/Reference/Global_Objects/Array/from#í™”ì‚´í‘œ_í•¨ìˆ˜ì™€_array.from_ì‚¬ìš©í•˜ê¸°)

```tsx
//api/items.ts
const items = Array.from({ length: 100 }).map((_, i) => ({
  id: i,
  name: `Item ${i}`,
}));

type Item = (typeof items)[0];

type Items = {
  data: Item[];
  currentPage: number;
  nextPage: number | null;
};

const LIMIT = 10;

export function fetchItems({
  pageParam,
}: {
  pageParam: number;
}): Promise<Items> {
  return new Promise((res, rej) => {
    setTimeout(() => {
      if (pageParam < 0) {
        rej("Invalid page parameter");
      }
      res({
        data: items.slice(pageParam, pageParam + LIMIT),
        currentPage: pageParam,
        nextPage: pageParam + LIMIT < items.length ? pageParam + LIMIT : null,
      });
    }, 1000);
  });
}
```

```tsx
//App.tsx
import { useInfiniteQuery } from "@tanstack/react-query";
import { useInView } from "react-intersection-observer";
import { fetchItems } from "./api/items";
import { useEffect } from "react";

function App() {
  const { data, status, error, fetchNextPage, isFetchingNextPage } =
    useInfiniteQuery({
      //ë°ì´í„° ì‹ë³„ì„ ìœ„í•œ í‚¤ ì„¤ì •
      queryKey: ["items"],
      //í˜ì´ì§€ë„¤ì´ì…˜ì„ ìœ„í•œ apií•¨ìˆ˜
      queryFn: fetchItems,
      //ì´ˆê¸° í˜ì´ì§€ state
      initialPageParam: 0,
      //ë‹¤ìŒ í˜ì´ì§€ë¥¼ ê°€ì ¸ì˜¤ê¸´ ìœ„í•œ í•¨ìˆ˜
      getNextPageParam: (lastPage) => lastPage.nextPage,
    });

  //ref - ê°ì§€í•  ìš”ì†Œ
  //inView - ìš”ì†Œ í™”ë©´ì— ë³´ì—¬ì§€ëŠ” ì—¬ë¶€
  const { ref, inView } = useInView();

  useEffect(() => {
    if (inView) {
      fetchNextPage();
    }
  }, [fetchNextPage, inView]);

  return status === "pending" ? (
    <div>Loading ...</div>
  ) : status === "error" ? (
    <div>{error.message}</div>
  ) : (
    <div className="flex flex-col gap-2">
      {data.pages.map((item) => {
        return (
          <div key={item.currentPage}>
            {item.data.map((item) => {
              return (
                <div key={item.id} className="p-4 rounded-md bg-grayscale-700">
                  {item.name}
                </div>
              );
            })}
          </div>
        );
      })}
      <div ref={ref}>{isFetchingNextPage && "Fetching~~~"}</div>
    </div>
  );
}

export default App;
```
